[  
   {  
      "$match":{  
         "issuer":{  
            "$ne":""
         }
      }
   },
   {  
      "$group":{  
         "_id":{  
            "isin":"$isin",
            "issue_date":"$issue_date",
            "issuer":"$issuer",
            "security":"$security"
         },
         "allEach":{  
            "$max":"$deal_size_mil"
         },
         "firmEach":{  
            "$sum":"$firm"
         },
         "geographic":{  
            "$addToSet":"$investor_region"
         },
         "investor":{  
            "$addToSet":"$type"
         }
      }
   },
   {  
      "$group":{  
         "_id":"$_id.isin",
         "list":{  
            "$push":{  
               "geographic":"$geographic",
               "investor":"$investor",
               "isin":"$_id.isin",
               "issue_date":"$_id.issue_date",
               "issuer":"$_id.issuer",
               "security":"$_id.security"
            }
         },
         "orderbook":{  
            "$sum":"$firmEach"
         },
         "size":{  
            "$max":"$allEach"
         }
      }
   },
   {  
      "$unwind":"$list"
   },
   {  
      "$sort":{  
         "country_parent":1
      }
   },
   {  
      "$limit":10
   },
   {  
      "$skip":0
   }
]
