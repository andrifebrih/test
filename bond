[  
   {  
      "$match":{  
         "issuer":{  
            "$ne":""
         }
      }
   },
   {  
      "$group":{  
         "_id":{  
            "issue_date":"$issue_date",
            "issuer":"$issuer",
            "security":"$security",
            "type":"$type"
         },
         "allEach":{  
            "$max":"$deal_size_mil"
         },
         "eachAllocType":{  
            "$sum":"$allocated_base"
         },
         "firmEach":{  
            "$sum":"$firm"
         },
         "geographic":{  
            "$addToSet":"$investor_region"
         },
         "investor":{  
            "$addToSet":"$type"
         }
      }
   },
   {  
      "$group":{  
         "TypeAlloc":{  
            "$sum":"$eachAllocType"
         },
         "_id":{  
            "geographic":"$geographic",
            "investor":"$investor",
            "issue_date":"$_id.issue_date",
            "issuer":"$_id.issuer",
            "security":"$_id.security"
         },
         "list":{  
            "$push":{  
               "eachAllocType":"$eachAllocType",
               "type":"$_id.type"
            }
         },
         "orderbook":{  
            "$sum":"$firmEach"
         },
         "size":{  
            "$max":"$allEach"
         }
      }
   },
   {  
      "$unwind":"$list"
   },
   {  
      "$sort":{  
         "country_parent":1
      }
   },
   {  
      "$limit":10
   },
   {  
      "$skip":0
   }
]
